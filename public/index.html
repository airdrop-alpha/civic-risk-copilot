<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Civic Risk Copilot dashboard for Montgomery, Alabama residents." />
    <title>Civic Risk Copilot | Montgomery Dashboard</title>
    <style>
      :root { --bg:#f3f7fb; --surface:#fff; --ink:#1b2a36; --muted:#5f7386; --line:#d7e1ea; --blue:#0f4c81; --blue2:#1d70b8; --good:#1f9d57; --moderate:#d3a208; --high:#d96a1c; --severe:#be2d2d; }
      * { box-sizing: border-box; }
      body { margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,sans-serif; background:var(--bg); color:var(--ink);} 
      .page { max-width:1240px; margin:0 auto; padding:18px 14px 90px; }
      .header { display:flex; justify-content:space-between; align-items:end; flex-wrap:wrap; gap:8px; margin-bottom:12px; }
      h1 { margin:0; color:#0c3b62; }
      .subtitle { color:var(--muted); margin:4px 0 0; font-size:.92rem; }
      .risk-banner { border-radius:14px; color:#fff; padding:14px 16px; margin-bottom:12px; box-shadow:0 10px 24px rgba(15,76,129,.25);} 
      .risk-top { display:flex; justify-content:space-between; gap:12px; align-items:center; flex-wrap:wrap; }
      .score-pill { background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.3); border-radius:999px; padding:6px 10px; font-weight:700; }
      .risk-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(190px,1fr)); gap:8px; margin-top:10px; }
      .risk-factor { background:rgba(255,255,255,.16); border-radius:10px; padding:8px; border:1px solid rgba(255,255,255,.28); }
      .risk-factor .meta { display:flex; justify-content:space-between; font-size:.8rem; opacity:.95; }
      .bar { margin-top:6px; width:100%; height:7px; background:rgba(255,255,255,.28); border-radius:99px; overflow:hidden; }
      .bar>span { display:block; height:100%; background:#fff; }

      .dashboard-grid { display:grid; grid-template-columns:1fr; gap:12px; }
      .card { background:var(--surface); border:1px solid var(--line); border-radius:12px; padding:14px; box-shadow:0 4px 14px rgba(17,44,70,.08); }
      .card h2 { margin:0 0 10px; color:var(--blue); font-size:1.02rem; }
      .kv { margin:5px 0; font-size:.92rem; }
      .kv span { color:var(--muted); }
      .badge { display:inline-flex; align-items:center; border-radius:999px; padding:3px 8px; font-size:.75rem; font-weight:600; border:1px solid transparent; }
      .badge.low,.good { background:#e8f7ef; color:#0d6f37; border-color:#b5e3ca; }
      .badge.moderate { background:#fff6db; color:#8f6c00; border-color:#f1da8a; }
      .badge.high { background:#ffeddf; color:#9f4800; border-color:#f3c39a; }
      .badge.severe { background:#fdeceb; color:#a22020; border-color:#efb5b5; }
      .badge.unknown { background:#edf1f5; color:#5b6c7c; border-color:#d2dce6; }
      .list { display:grid; gap:8px; max-height:230px; overflow:auto; }
      .item { border:1px solid var(--line); border-left:5px solid var(--blue2); border-radius:8px; padding:8px; background:#fbfdff; font-size:.87rem; }
      .item.low{border-left-color:var(--good)} .item.moderate{border-left-color:var(--moderate)} .item.high{border-left-color:var(--high)} .item.severe{border-left-color:var(--severe)}
      .forecast-strip { display:grid; grid-template-columns:repeat(7,minmax(95px,1fr)); gap:8px; overflow:auto; }
      .forecast-day { border:1px solid var(--line); border-radius:10px; padding:8px; text-align:center; background:#f8fcff; min-width:95px; }
      .chat-fab { position:fixed; right:14px; bottom:14px; border:none; border-radius:999px; padding:12px 14px; color:#fff; background:var(--blue); font-weight:700; box-shadow:0 10px 24px rgba(8,61,102,.28); cursor:pointer; }
      .chat-panel { position:fixed; right:14px; bottom:66px; width:min(390px,calc(100vw - 28px)); height:470px; display:none; background:#fff; border:1px solid var(--line); border-radius:12px; overflow:hidden; box-shadow:0 18px 42px rgba(8,61,102,.25); }
      .chat-panel.open{display:grid;grid-template-rows:auto auto 1fr auto}
      .chat-head{background:#083d66;color:#fff;padding:10px 12px;font-weight:700}
      .suggested{display:flex;flex-wrap:wrap;gap:6px;padding:8px;background:#f7fbff;border-bottom:1px solid var(--line)}
      .suggested button{border:1px solid #bdd6eb;background:#fff;border-radius:999px;padding:6px 9px;cursor:pointer;font-size:.78rem}
      .messages{padding:10px;overflow-y:auto;background:linear-gradient(180deg,#f8fbff,#fefefe)}
      .msg{margin:8px 0;border-radius:10px;padding:8px 10px;max-width:92%;white-space:pre-wrap;font-size:.9rem}
      .msg.user{margin-left:auto;background:#0f4c81;color:#fff}.msg.bot{background:#fff;border:1px solid var(--line)}
      .chat-form{display:grid;grid-template-columns:1fr auto;gap:8px;padding:10px;border-top:1px solid var(--line)}
      .chat-form input{border:1px solid #b6cde2;border-radius:8px;padding:10px}.chat-form button{border:none;border-radius:8px;background:#0f4c81;color:#fff;padding:10px 12px}
      @media (min-width:900px){ .dashboard-grid{ grid-template-columns:repeat(2,minmax(0,1fr)); } .span-2{grid-column:span 2;} }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="header"><div><h1>Montgomery Civic Risk Dashboard</h1><p class="subtitle">Live civic risk intelligence for Montgomery, Alabama</p></div><div class="subtitle">Last updated: <strong id="last-updated">Loading...</strong></div></header>

      <section id="risk-banner" class="risk-banner"><div class="risk-top"><strong>Overall Risk: Loading...</strong><span class="score-pill" id="overall-score">Score --</span></div><p id="risk-method">Weighted multi-hazard model loading...</p><div id="risk-breakdown" class="risk-grid"></div></section>

      <section class="dashboard-grid">
        <article class="card" id="weather-card"><h2>Current Weather</h2><div>Loading...</div></article>
        <article class="card" id="alerts-card"><h2>Active Alerts</h2><div>Loading...</div></article>
        <article class="card" id="aqi-card"><h2>Air Quality</h2><div>Loading...</div></article>
        <article class="card" id="quake-card"><h2>Earthquake Activity (7d)</h2><div>Loading...</div></article>
        <article class="card" id="incidents-card"><h2>Community Safety</h2><div>Loading...</div></article>
        <article class="card" id="services-card"><h2>City Services</h2><div>Loading...</div></article>
        <article class="card" id="flood-card"><h2>Flood Watch</h2><div>Loading...</div></article>
        <article class="card span-2" id="forecast-card"><h2>7-Day Forecast</h2><div class="forecast-strip" id="forecast-strip"></div></article>
        <article class="card span-2" id="news-card"><h2>Breaking Local Risk News</h2><div>Loading...</div></article>
      </section>
    </div>

    <button class="chat-fab" id="chat-toggle">Open AI Copilot</button>
    <aside class="chat-panel" id="chat-panel"><div class="chat-head">AI Civic Copilot</div><div class="suggested" id="suggested-questions"></div><div class="messages" id="messages"><div class="msg bot">Ask about flood, heat, AQI, or emergency prep.</div></div><form class="chat-form" id="chat-form"><input id="chat-input" placeholder="What should I do about today's risks?" required /><button type="submit">Send</button></form></aside>

    <script>
      const suggestedQuestions=['What is the biggest risk in Montgomery today?','Should I avoid any roads due to flooding?','Are there severe weather alerts right now?','How does air quality affect outdoor plans today?'];
      const titleCase = (t='') => t.replace(/\b\w/g,m=>m.toUpperCase());
      const severityClass=(v='')=>{v=v.toLowerCase();if(v.includes('severe'))return'severe';if(v.includes('high')||v.includes('unhealthy'))return'high';if(v.includes('moderate'))return'moderate';if(v.includes('low')||v.includes('good'))return'low';return'unknown';};
      const riskBannerStyle=(l)=>l==='severe'?'linear-gradient(90deg,#8b1f17,#c0392b)':l==='high'?'linear-gradient(90deg,#b35c16,#e67e22)':l==='moderate'?'linear-gradient(90deg,#a17a00,#e1b12c)':'linear-gradient(90deg,#116b36,#1e9f51)';
      const createList=(items,fmt)=>!items?.length?'<p class="subtitle">No records right now.</p>':`<div class="list">${items.map(fmt).join('')}</div>`;

      function updateRiskBanner(d){
        const level=d.overallRisk||'unknown';
        const rb=d.riskBreakdown||{};
        const banner=document.getElementById('risk-banner');
        banner.style.background=riskBannerStyle(level);
        banner.querySelector('strong').textContent=`Overall Risk Level: ${titleCase(level)}`;
        document.getElementById('overall-score').textContent=`Score ${d.overallScore ?? '--'} / 100`;
        document.getElementById('risk-method').textContent=rb.methodology || 'Weighted model';
        document.getElementById('risk-breakdown').innerHTML=(rb.factors||[]).map(f=>`
          <div class="risk-factor"><div class="meta"><strong>${f.label}</strong><span>${Math.round(f.score)}</span></div><div class="bar"><span style="width:${Math.min(100,f.score)}%"></span></div><div class="meta"><span>${titleCase(f.level)}</span><span>w ${Math.round(f.weight*100)}%</span></div></div>`).join('');
      }

      function updateWeatherCard(w){const c=w.current||{};document.getElementById('weather-card').innerHTML=`<h2>Current Weather</h2><p class="kv"><span>Condition:</span> ${c.weather_description||'Unknown'}</p><p class="kv"><span>Temperature:</span> ${c.temperature_2m ?? 'N/A'} ${w.current_units?.temperature_2m||''}</p><p class="kv"><span>Wind:</span> ${c.wind_speed_10m ?? 'N/A'} ${w.current_units?.wind_speed_10m||''}</p><p class="kv"><span>Humidity:</span> ${c.relative_humidity_2m ?? 'N/A'} ${w.current_units?.relative_humidity_2m||''}</p>`;}
      function updateAlertsCard(a){const rows=(a.alerts||[]).slice(0,8);document.getElementById('alerts-card').innerHTML=`<h2>Active Alerts</h2>${createList(rows,r=>`<div class="item ${severityClass(r.severity)}"><strong>${r.event||r.type||'Alert'}</strong><div>${r.headline||r.detail||'No details'}</div></div>`)}`;}
      function updateAqiCard(a){const cls=severityClass(a.classification?.level);document.getElementById('aqi-card').innerHTML=`<h2>Air Quality</h2><p class="kv"><span>US AQI:</span> ${a.current?.us_aqi ?? 'N/A'} <span class="badge ${cls}">${a.classification?.label||'Unknown'}</span></p><p class="kv"><span>PM2.5:</span> ${a.current?.pm2_5 ?? 'N/A'} ${a.current_units?.pm2_5||''}</p><p class="kv"><span>Ozone:</span> ${a.current?.ozone ?? 'N/A'} ${a.current_units?.ozone||''}</p>`;}
      function updateQuakeCard(q){const rows=(q.events||[]).slice(0,6);document.getElementById('quake-card').innerHTML=`<h2>Earthquake Activity (7d)</h2><p class="kv"><span>Events:</span> ${q.total ?? 0}</p><p class="kv"><span>Max magnitude:</span> ${q.maxMagnitude ?? 0} <span class="badge ${severityClass(q.severity)}">${titleCase(q.severity||'low')}</span></p>${createList(rows,e=>`<div class="item ${severityClass(e.severity)}"><strong>M${e.magnitude ?? 'N/A'} - ${e.place||'Unknown place'}</strong><div>${e.time?new Date(e.time).toLocaleString():'Unknown time'}</div></div>`)}`;}
      function updateIncidentsCard(i){const rows=(i.incidents||[]).slice(0,6);document.getElementById('incidents-card').innerHTML=`<h2>Community Safety</h2>${createList(rows,r=>`<div class="item ${severityClass(r.severity)}"><strong>${r.type}</strong><div>${r.location||'Montgomery area'}${r.time?` | ${new Date(r.time).toLocaleString()}`:''}</div></div>`)}`;}
      function updateCityServicesCard(s){const rows=(s.announcements||[]).slice(0,6);document.getElementById('services-card').innerHTML=`<h2>City Services</h2><p class="subtitle">${s.note||''}</p>${createList(rows,a=>`<div class="item low"><strong>${a.title}</strong><div>${a.link?`<a href="${a.link}" target="_blank" rel="noopener noreferrer">View notice</a>`:''}</div></div>`)}`;}
      function updateFloodCard(f){const rows=(f.gauges||[]).slice(0,6);document.getElementById('flood-card').innerHTML=`<h2>Flood Watch</h2><p class="kv"><span>Highest Gauge Risk:</span> <span class="badge ${severityClass(f.highestRisk)}">${titleCase(f.highestRisk||'unknown')}</span></p>${createList(rows,g=>`<div class="item ${severityClass(g.riskLevel)}"><strong>${g.siteName||g.siteCode}</strong><div>Stage: ${g.stageFeet ?? 'N/A'} ${g.stageUnit||'ft'} | Discharge: ${g.dischargeCfs ?? 'N/A'} ${g.dischargeUnit||'cfs'}</div></div>`)}`;}
      function updateForecast(w){const d=w.daily?.time||[];const mx=w.daily?.temperature_2m_max||[];const mn=w.daily?.temperature_2m_min||[];const p=w.daily?.precipitation_probability_max||[];document.getElementById('forecast-strip').innerHTML=d.map((date,i)=>`<div class="forecast-day"><strong>${new Date(date).toLocaleDateString([], { weekday: 'short' })}</strong><div>${mx[i]??'-'} / ${mn[i]??'-'} ${w.daily_units?.temperature_2m_max||''}</div><div>${p[i]??'-'}${w.daily_units?.precipitation_probability_max||'%'}</div></div>`).join('');}
      function updateNewsCard(n){const rows=(n.stories||[]).slice(0,8);document.getElementById('news-card').innerHTML=`<h2>Breaking Local Risk News</h2>${createList(rows,s=>`<div class="item moderate"><strong>${s.title}</strong><div>${s.source} | <a href="${s.link}" target="_blank" rel="noopener noreferrer">Open story</a></div></div>`)}`;}

      function addMessage(text, role='bot', sources=[]){const m=document.getElementById('messages');const w=document.createElement('div');w.className=`msg ${role}`;w.textContent=text;if(role==='bot'&&sources.length){const s=document.createElement('div');s.className='subtitle';s.textContent=`Sources: ${sources.join(', ')}`;w.appendChild(s);}m.appendChild(w);m.scrollTop=m.scrollHeight;}
      async function loadDashboard(){try{const res=await fetch('/api/dashboard');const d=await res.json();document.getElementById('last-updated').textContent=new Date(d.updatedAt).toLocaleString();updateRiskBanner(d);updateWeatherCard(d.weather||{});updateAlertsCard(d.alerts||{});updateAqiCard(d.airQuality||{});updateQuakeCard(d.earthquakes||{});updateIncidentsCard(d.incidents||{});updateCityServicesCard(d.cityServices||{});updateFloodCard(d.flood||{});updateForecast(d.weather||{});updateNewsCard(d.news||{});}catch{document.getElementById('last-updated').textContent='Unavailable';addMessage('Dashboard data failed to load. Some sources may be unavailable.','bot');}}
      function setupChat(){const p=document.getElementById('chat-panel');const t=document.getElementById('chat-toggle');const f=document.getElementById('chat-form');const i=document.getElementById('chat-input');const sq=document.getElementById('suggested-questions');t.addEventListener('click',()=>{p.classList.toggle('open');t.textContent=p.classList.contains('open')?'Close AI Copilot':'Open AI Copilot';});sq.innerHTML=suggestedQuestions.map(q=>`<button type="button" data-q="${q.replace(/"/g,'&quot;')}">${q}</button>`).join('');sq.addEventListener('click',e=>{const b=e.target.closest('button[data-q]');if(!b)return;i.value=b.dataset.q;i.focus();});f.addEventListener('submit',async e=>{e.preventDefault();const message=i.value.trim();if(!message)return;addMessage(message,'user');i.value='';try{const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message})});const data=await res.json();addMessage(data.answer||'No response available.','bot',data.sources||[]);}catch{addMessage('Chat request failed. Please try again shortly.','bot');}});}
      setupChat(); loadDashboard(); setInterval(loadDashboard,5*60*1000);
    </script>
  </body>
</html>
